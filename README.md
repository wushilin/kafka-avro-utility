# Kafka Avro Utility

A high-performance Rust toolkit for generating random Avro data and producing it to Kafka, with support for Confluent Schema Registry.

## Overview

This project provides a set of tools to help with performance testing and data generation for Kafka ecosystems that use Avro.

The toolkit consists of three main binaries:

1.  **`kafka-avro-utility`** (Main Producer): Generates random Avro records based on a schema and field specification, and produces them directly to Kafka.
2.  **`avrogen`**: Generates random Avro records and writes them to a file (supports Zstd compression).
3.  **`avroproducer`**: Reads raw Avro records from a file (generated by `avrogen`) and efficiently produces them to Kafka.

## Installation

Build the project using Cargo:

```bash
cargo build --release
```

The binaries will be available in `target/release/`.

## Usage

### 1. Main Producer (`kafka-avro-utility`)

Generates data on-the-fly and sends it to Kafka.

```bash
./target/release/kafka-avro-utility \
  --topic test-topic \
  --schema-file schemas/person.avsc \
  --field-spec field_spec.txt \
  --rate 1000 \
  --threads 4 \
  --command-config client.properties \
  --schema-registry-config sr.properties
```

**Key Arguments:**
*   `--topic`: Destination Kafka topic.
*   `--schema-file`: Path to the Avro schema file (`.avsc`).
*   `--field-spec`: Path to the field generation specification file.
*   `--rate`: Rate limit in messages per second (per thread).
*   `--threads`: Number of producer threads.
*   `--num-messages`: Total number of messages to send (-1 for unlimited).

### 2. Data Generator (`avrogen`)

Generates random Avro data to a file. Useful for creating large datasets for replay or offline testing.

```bash
./target/release/avrogen \
  --schema schemas/person.avsc \
  --out data.avro.zst \
  --num-messages 1000000 \
  --field-spec field_spec.txt
```

**Key Arguments:**
*   `--schema`: Path to Avro schema file.
*   `--out`: Output file path.
    *   Must end in `.avro.zst` (default, compressed).
    *   Must end in `.avro` if `--disable-compression` is used.
*   `--num-messages`: Number of records to generate.
*   `--disable-compression`: Disable Zstd compression.
*   `--compress-level`: Zstd compression level (default: 3).

### 3. File Producer (`avroproducer`)

Replays data from a file generated by `avrogen` to Kafka. This is often more efficient than on-the-fly generation for very high throughput tests.

```bash
./target/release/avroproducer \
  --topic test-topic \
  --in-file data.avro.zst \
  --client-config client.properties \
  --sr-config sr.properties \
  --speed 50.0
```

**Key Arguments:**
*   `--topic`: Destination Kafka topic.
*   `--in-file`: Input file path (supports `.avro` and `.avro.zst`).
*   `--speed`: Speed limit in MiB/s (optional).
*   `--num-messages`: Stop after producing N messages (optional).

## Field Specification

The field specification file defines how to generate random data for each field in your Avro schema.
For full documentation on available functions and syntax, see [FIELD_SPEC.md](FIELD_SPEC.md).

**Format:**
```text
field_name, template:${function(args)} constant_text ${other_function()}
```

**Example:**
```text
# Sequence that starts with 1 and increments by 1 each call
id, template:${seq(1)}
# UUID generation
user_id, template:${uuid()}
# Random name generation
name, template:${name()}
# Random age generation, both inclusive
age, template:${range(18, 80)}
# IP address generation (IPv4)
ip, template:${ip_addr(4)}
# IP address generation (IPv6)
ip1, template:${ip_addr(6)}
# Current timestamp in milliseconds
event_time, template:${now_ms()}
# Current timestamp in nanoseconds
event_time_ns, template:${now_micros()}
# Current date formatted string
date, template:${date("%Y-%m-%d")}
# Current date formatted string in range
date_range, template:${date("%Y-%m-%d", "2020-01-01", "2023-12-31")}
# random event with meaningful name
description, template:User ${name()} logged in from ${ip_addr(4)}
# Choice for enum or string
status, template:${choice(["active", "inactive"])}
# Weighted choice for enum or string, active weight is 10, inactive weight is 20
status_weight, template:${choice_weight([10, "active", 20, "inactive"])}
# Random string with length between 5 and 10, prfixed with `str-`
stringField,template:str-${random_string([5, 10])}
```

### Available Functions

| Function | Description | Example |
| `seq(start)` | Thread-safe incremental counter starting from `start`. | `${seq(1)}` |
| `range([min, max])` | Random integer between `min` and `max` (inclusive). | `${range([1, 100])}` |
| `random_float([min, max])` | Random float between `min` and `max`. | `${random_float([0.0, 1.0])}` |
| `random_string([min, max])` | Random alphanumeric string with length between `min` and `max`. | `${random_string([5, 10])}` |
| `choice(["val1", "val2"])` | Randomly select one value from the list. | `${choice(["active", "inactive"])}` |
| `choice_weight([w1, "v1", w2, "v2"])` | Weighted random selection. | `${choice_weight([10, "Rare", 90, "Common"])}` |
| `uuid()` | Generate a random UUID v4. | `${uuid()}` |
| `name()` | Generate a random full name. | `${name()}` |
| `address()` | Generate a random realistic address. | `${address()}` |
| `ipaddr(version)` | Generate a random IP address (4 or 6). | `${ipaddr(4)}` |
| `bytes([len])` | Generate a random ASCII string of specific length (for bytes/fixed). | `${bytes([10])}` |
| `fixed([len])` | Alias for `bytes`. | `${fixed([16])}` |
| `date(format)` | Current date/time formatted using strftime syntax. | `${date("%Y-%m-%d")}` |
| `date(format, start, end)` | Random date between start and end dates. Begin and End dates are inclusive. You can use formats like 2025-01-01[ 11:02:50][.478] The time part, and millisecond part are optional. The first argument specifies the output date format. | `${date("%Y-%m-%d %H:%M:%S", "2020-01-01", "2023-12-31")}` |
| `date_int()` | Days since Unix Epoch (for Avro `date` logical type). | `${date_int()}` |
| `now_ms()` | Current timestamp in milliseconds. | `${now_ms()}` |
| `now_micros()` | Current timestamp in microseconds. | `${now_micros()}` |
| `now_nanos()` | Current timestamp in nanoseconds. | `${now_nanos()}` |
| `formatted(["fmt", min, max])` | Generate a formatted number (int or float) within range. | `${formatted(["{:04}", 1, 100])}` |
| `invokejs(["func", arg1, ...])` | Invoke a custom JavaScript function defined in the file. | `${invokejs(["myFunc", "arg1"])}` |

### JavaScript Scripting

You can define custom JavaScript functions at the bottom of the field spec file (separated by `----------`).

```text
custom_field, template:${invokejs(["myCustomFunc", "arg1"])}

----------
function myCustomFunc(arg) {
    return "Processed " + arg + " at " + new Date().toISOString();
}
```

## Configuration

### Kafka Client (`client.properties`)
Standard java kafka properties.
```properties
bootstrap.servers=localhost:9092
security.protocol=PLAINTEXT
# sasl.mechanism=PLAIN
# sasl.username=...
# sasl.password=...
```

### Schema Registry (`sr.properties`)
Standard schema registry properties.
```properties
schema.registry.url=http://localhost:8081
# schema.registry.basic.auth.user.info=user:pass
```
