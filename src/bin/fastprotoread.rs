use clap::Parser;
use kafka_avro_utility::fastprotofile::load_bytes_file;
use std::path::PathBuf;

#[derive(Parser, Debug)]
#[command(name = "fastprotoread")]
#[command(
    about = "Fast reading of Protobuf records from a file generated by protogen (skips deserialization)"
)]
struct Args {
    /// Input file path
    #[arg(long, required = true)]
    in_file: PathBuf,

    /// Print the raw byte length of each record
    #[arg(long, default_value_t = false)]
    print: bool,
}

fn main() -> Result<(), Box<dyn std::error::Error>> {
    let args = Args::parse();

    let (schema_text, message_name, iterator) = load_bytes_file(&args.in_file)?;

    println!("Schema loaded ({} bytes). Message: {}", schema_text.len(), message_name);

    let mut count = 0;
    for entry in iterator {
        match entry {
            Ok(bytes_entry) => {
                if args.print {
                    println!(
                        "Record {}: {} bytes",
                        count + 1,
                        bytes_entry.get_data().len()
                    );
                }
                count += 1;
                if count % 10000 == 0 {
                    println!("Processed {} records...", count);
                }
            }
            Err(e) => {
                eprintln!("Error reading record {}: {}", count + 1, e);
                break;
            }
        }
    }

    println!("Total records read: {}", count);

    Ok(())
}

