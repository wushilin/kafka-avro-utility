use clap::Parser;
use humansize::{format_size, DECIMAL};
use kafka_avro_utility::protofile::load_proto_file;
use std::path::PathBuf;

#[derive(Parser, Debug)]
#[command(name = "protoread")]
#[command(about = "Read and print Protobuf records from a file generated by protogen")]
struct Args {
    /// Input file path
    #[arg(long, required = true)]
    in_file: PathBuf,

    /// Name of the message type to decode (fully qualified). Optional if reading from self-describing format.
    #[arg(long)]
    message: Option<String>,

    #[arg(long, default_value_t = false)]
    print: bool,
}

fn main() -> Result<(), Box<dyn std::error::Error>> {
    let args = Args::parse();

    let (_pool, message_name, mut iterator) = load_proto_file(&args.in_file, args.message.as_deref())?;

    println!("Schema loaded and message '{}' found.", message_name);

    let mut count = 0;
    while let Some(record) = iterator.next() {
        match record {
            Ok(message) => {
                if args.print {
                    println!("Record {}:", count + 1);
                    println!("{:#?}", message);
                }
                count += 1;
                if count % 10000 == 0 {
                     println!(
                        "Processed {} records (Uncompressed: {})...",
                        count,
                        format_size(iterator.total_bytes_read, DECIMAL)
                    );
                }
            }
            Err(e) => {
                eprintln!("Error reading record {}: {}", count + 1, e);
                break;
            }
        }
    }

    let file_size = std::fs::metadata(&args.in_file)?.len();
    let ratio = if file_size > 0 {
        iterator.total_bytes_read as f64 / file_size as f64
    } else {
        0.0
    };

    println!(
        "Total records read: {}\nTotal Uncompressed: {}\nCompressed File Size: {}\nCompression Ratio: {:.2}x",
        count,
        format_size(iterator.total_bytes_read, DECIMAL),
        format_size(file_size, DECIMAL),
        ratio
    );

    Ok(())
}



